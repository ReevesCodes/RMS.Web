@model RMS.Data.Entities.Product

@{
    ViewData["Title"] = Model.Name;
}

<div class="container mt-4" aria-live="polite" aria-atomic="true" role="region">
    <h2 tabindex="0">@Model.Name</h2>
    <p tabindex="0">@Model.Description</p>
    <p tabindex="0"><strong>Price:</strong> @Model.Price.ToString("C")</p>

    <hr />

    <!-- Review Section -->
    <div class="card mb-4 shadow-sm rounded" aria-label="Customer Reviews Section">
        <div class="card-body">
            <h4 tabindex="0">Customer Reviews</h4>
            @if (Model.Reviews?.Any() ?? false)
            {
                foreach (var review in Model.Reviews)
                {
                    <div class="border rounded p-3 mb-3 bg-light review-box" tabindex="0" onfocus="readReview(this)">
                        <strong>@(review.User?.UserName ?? review.GuestName ?? "Guest")</strong>
                        <div class="text-warning" aria-label="@review.Rating out of 5 stars">
                            @for (int i = 1; i <= 5; i++)
                            {
                                if (i <= review.Rating)
                                {
                                    <span class="fa fa-star" aria-hidden="true"></span>
                                }
                                else
                                {
                                    <span class="fa fa-star-o" aria-hidden="true"></span>
                                }
                            }
                        </div>
                        <p>@review.Comment</p>
                        <small class="text-muted">@review.CreatedAt.ToShortDateString()</small>

                        <!-- Delete Review Button -->
                        @if (User.IsInRole("Admin") || review.UserId?.ToString() == User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value)
                        {
                            <form asp-controller="Review" asp-action="Delete" asp-route-id="@review.Id" method="post" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-danger mt-2"
                                        aria-label="Delete this review"
                                        onclick="return confirm('Are you sure you want to delete this review?');">
                                    Delete
                                </button>
                            </form>
                        }
                    </div>
                }
            }
            else
            {
                <p tabindex="0">No reviews yet. Be the first to review this product!</p>
            }
        </div>
    </div>

    <!-- Add Review Form -->
    <div class="card shadow-sm rounded" aria-label="Add Review Section">
        <div class="card-body">
            <h4 tabindex="0">Add a Review</h4>
            <form asp-controller="Review" asp-action="Create" method="post" id="reviewForm" aria-label="Add review form">
                <input type="hidden" name="ProductId" value="@Model.Id" />

                <div class="mb-3">
                    <label for="GuestName" class="form-label">Your Name (optional)</label>
                    <input type="text" class="form-control" name="GuestName" id="GuestName" placeholder="Leave blank for Guest" />
                </div>

                <div class="mb-3">
                    <label for="Rating" class="form-label">Rating</label>
                    <select class="form-select" name="Rating" id="Rating" required>
                        @for (int i = 1; i <= 5; i++)
                        {
                            <option value="@i">@i Star@(i > 1 ? "s" : "")</option>
                        }
                    </select>
                </div>

                <div class="mb-3">
                    <label for="Comment" class="form-label">Comment</label>
                    <textarea class="form-control" name="Comment" id="Comment" rows="3" required></textarea>
                </div>

                <button type="submit" class="btn btn-success">Submit Review</button>
            </form>
        </div>
    </div>
</div>

<!-- Accessibility Script -->
<script>
    function speak(text) {
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'en-US';
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utter);
    }

    function readReview(element) {
        const username = element.querySelector('strong')?.innerText || 'Anonymous';
        const rating = element.querySelectorAll('.fa-star').length;
        const comment = element.querySelector('p')?.innerText || '';
        const date = element.querySelector('small')?.innerText || '';
        speak(`Review by ${username}, ${rating} stars. Comment: ${comment}. Date: ${date}.`);
    }

    document.addEventListener("DOMContentLoaded", function () {
        speak(`Now viewing product details for ${document.querySelector('h2').innerText}`);
    });
</script>
